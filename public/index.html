<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Запись на маникюр</title>
</head>
<body>
<h2>Запись на маникюр</h2>
<label>Дата: <input type="date" id="date" /></label>
<div>
  <label>Услуга:
    <select id="service">
      <option value="S">S — короткие</option>
      <option value="M">M — средние</option>
      <option value="L">L — длинные</option>
    </select>
  </label>
</div>
<button id="check">Показать слоты</button>
<div id="slots"></div>
<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();
  const user = tg?.initDataUnsafe?.user || {};
  document.getElementById('check').onclick = async () => {
    const date = document.getElementById('date').value;
    if (!date) { alert('Выберите дату'); return; }
    const res = await fetch(`/slots?date=${encodeURIComponent(date)}`);
    const data = await res.json();
    const container = document.getElementById('slots');
    container.innerHTML = '';
    if (!data.available || data.available.length === 0) { container.innerText = 'Нет доступных слотов'; return; }
    data.available.forEach(t => {
      const btn = document.createElement('button');
      btn.innerText = t;
      btn.onclick = async () => {
        const service = document.getElementById('service').value;
        const resp = await fetch('/book', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({date, time: t, service, userId: user.id || 'anon', name: user.first_name || ''})
        });
        if (resp.status === 200) { alert('Запись подтверждена'); btn.disabled = true; }
        else if (resp.status === 409) alert('Уже занято');
        else { const e = await resp.json().catch(()=>({error:'unknown'})); alert(e.error || 'Ошибка'); }
      };
      container.appendChild(btn);
      container.appendChild(document.createTextNode(' '));
    });
  };
</script>
</body>
</html>